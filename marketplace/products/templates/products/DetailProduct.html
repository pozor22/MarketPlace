{% extends 'products/base.html' %}

{% block title %} {{ title }} {% endblock %}

{% block style %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'products/DetailProduct.css' %}">
{% endblock %}

{% block main %}
<div class="product-detail-container">
    <div class="product-detail-image">
        <!-- –°–ª–∞–π–¥–µ—Ä –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Ç–æ–≤–∞—Ä–∞ -->
        <div class="product-slider">
            {% for image in product.images.all %}
                <div class="slider-item">
                    <img
                        src="data:image/png;base64,{{ image.get_image_base64 }}"
                        alt="{{ product.name }} image {{ forloop.counter }}"
                    >
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="product-detail-info">
        <p>–û—Ü–µ–Ω–∫–∞: {{ ratings_count }} / 5</p>

        <button id="like-btn" class="like-btn" data-liked="{{ is_liked }}">
            <span id="like-text">{% if is_liked %}üíñ –õ–∞–π–∫–Ω—É—Ç–æ{% else %}ü§ç –õ–∞–π–∫{% endif %}</span>
            (<span id="likes-count">{{ likes_count }}</span>)
        </button>

        <h1>{{ product.name }}</h1>
        <p class="product-description">{{ product.description }}</p>
        <p class="product-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ product.category.name }}</p>
        <p class="product-price">–¶–µ–Ω–∞: {{ product.price }}‚ÇΩ</p>
        <p class="product-author">–ê–≤—Ç–æ—Ä: {{ product.author.username }}</p>
        <a href="{% url 'home' %}" class="back-link">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–æ–≤–∞—Ä–∞–º</a>
    </div>
</div>

<!-- –ë–ª–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<div class="comments-container">
    <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>

    {% if user.is_authenticated %}
    <div class="comment-form-container">
        <form method="post" class="comment-form">
            {% csrf_token %}
            <div>
                {{ form_comment.rate.label_tag }}
                {{ form_comment.rate }}
            </div>
            <div class="form-group">
                {{ form_comment.text.label_tag }}
                {{ form_comment.text }}
            </div>
            <button type="submit" class="comment-button">–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </form>
    </div>
    {% else %}
    <p class="not-authenticated">–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
    {% endif %}

    <div class="comments-list">
        {% for comment in comments %}
        <div class="comment">
            <p class="comment-author">{{ comment.author.username }}</p>
            <p class="comment-author">–û—Ü–µ–Ω–∫–∞: {{ comment.rate }} / 5</p>
            <p class="comment-text">{{ comment.text }}</p>
            <p class="comment-date">{{ comment.formatted_date }}</p>
        </div>
        {% empty %}
        <p class="no-comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.getElementById("like-btn").addEventListener("click", function() {
    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "like=1"
    })
    .then(response => response.json())
    .then(data => {
        let btn = document.getElementById("like-btn");
        let text = document.getElementById("like-text");
        let count = document.getElementById("likes-count");

        if (data.liked) {
            text.innerHTML = "üíñ –õ–∞–π–∫–Ω—É—Ç–æ";
        } else {
            text.innerHTML = "ü§ç –õ–∞–π–∫";
        }
        count.innerHTML = data.likes_count;
    });
});

    document.querySelectorAll('.product-slider').forEach(slider => {
        let currentIndex = 0;
        const items = slider.querySelectorAll('.slider-item');

        function showSlide(index) {
            items.forEach((item, i) => {
                item.style.display = i === index ? 'block' : 'none';
            });
        }

        showSlide(currentIndex);

        const nextButton = document.createElement('button');
        nextButton.innerText = '–í–ø–µ—Ä–µ–¥';
        nextButton.onclick = () => {
            currentIndex = (currentIndex + 1) % items.length;
            showSlide(currentIndex);
        };

        const prevButton = document.createElement('button');
        prevButton.innerText = '–ù–∞–∑–∞–¥';
        prevButton.onclick = () => {
            currentIndex = (currentIndex - 1 + items.length) % items.length;
            showSlide(currentIndex);
        };

        slider.appendChild(prevButton);
        slider.appendChild(nextButton);
    });
</script>
{% endblock %}

