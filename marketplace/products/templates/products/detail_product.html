{% extends 'users/base.html' %}

{% block title %} {{ title }} {% endblock %}

{% block style %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'products/detail_product.css' %}">
{% endblock %}

{% block main %}
<div class="product-detail-container">
    <div class="product-detail-image">
        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
        {% if product.images.count > 1 %}
            <!-- –°–ª–∞–π–¥–µ—Ä –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Ç–æ–≤–∞—Ä–∞ -->
            <div class="product-slider">
                {% for image in product.images.all %}
                    <div class="slider-item">
                        <img
                            src="data:image/png;base64,{{ image.get_image_base64 }}"
                            alt="{{ product.name }} image {{ forloop.counter }}"
                        >
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- –ï—Å–ª–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –æ–¥–Ω–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ—ë –±–µ–∑ —Å–ª–∞–π–¥–µ—Ä–∞ -->
            {% if product.images.first %}
                <img
                    src="data:image/png;base64,{{ product.images.first.get_image_base64 }}"
                    alt="{{ product.name }} image"
                    class="single-image"
                >
            {% else %}
                <p>–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.</p>
            {% endif %}
        {% endif %}
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –≤–∞—à–µ–≥–æ —à–∞–±–ª–æ–Ω–∞ -->
    <div class="product-detail-info">
        {% if product.get_ratings %}
            <p> –û—Ü–µ–Ω–∫–∞ {{ product.get_ratings|floatformat:1 }} / 5</p>
        {% else %}
            <p> –ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</p>
        {% endif %}
        <button id="like-btn" class="like-btn" data-liked="{{ is_liked }}">
            <span id="like-text">{% if is_liked %}üíñ –õ–∞–π–∫–Ω—É—Ç–æ{% else %}ü§ç –õ–∞–π–∫{% endif %}</span>
            (<span id="likes-count">{{ likes_count }}</span>)
        </button>
        <h1>{{ product.name }}</h1>
        <p class="product-description">{{ product.description }}</p>
        <p class="product-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ product.category.name }}</p>
        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–∫–∏ -->
        <p class="product-price">
            {% if product.discount > 0 %}
                <!-- –ï—Å–ª–∏ —Å–∫–∏–¥–∫–∞ –µ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞—á–µ—Ä–∫–Ω—É—Ç—É—é —Ü–µ–Ω—É, –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É –∏ —Å–∫–∏–¥–∫—É -->
                <span style="text-decoration: line-through; color: #999;">{{ product.price }}‚ÇΩ</span>
                <span style="color: #ff6600; font-weight: bold;">{{ product.total_price }}‚ÇΩ</span>
                <span style="color: green; font-weight: bold;">({{ product.discount }}% —Å–∫–∏–¥–∫–∞)</span>
            {% else %}
                <!-- –ï—Å–ª–∏ —Å–∫–∏–¥–∫–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É -->
                <span style="color: #ff6600; font-weight: bold;">{{ product.price }}‚ÇΩ</span>
            {% endif %}
        </p>
        <p class="product-author">–ê–≤—Ç–æ—Ä: {{ product.author.username }}</p>
        <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="add_to_basket" value="{{ product.id }}">
                <button type="submit" class="add-to-basket-button" onclick="return confirm('–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É?')">
                    –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
                </button>
        </form>
        <a href="{% url 'home' %}" class="back-link">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–æ–≤–∞—Ä–∞–º</a>
    </div>
</div>

<!-- –ë–ª–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<div class="comments-container">
    <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>

    {% if user.is_authenticated %}
        {% if is_comment %}
            <p>–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</p>
            <div class="comment-form-container">
                <div class="user-comment">
                    <p>–û—Ü–µ–Ω–∫–∞: {{ comment.rate }} / 5</p>
                    <p>{{ comment.text }}</p>
                </div>
                <div class="comment-buttons">
                    <button id="edit-comment-btn" class="comment-button">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="delete" value="1">
                        <button type="submit"
                                onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç?')"
                                class="comment-button delete-button">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </form>
                </div>
            </div>
            <div id="edit-comment-form-container" class="edit-comment-form-container" style="display:none;">
                <form method="post" class="comment-form">
                    {% csrf_token %}
                    <div>
                        <p>–û—Ü–µ–Ω–∫–∞:</p>
                        <div class="rating">
                            <input type="radio" id="edit-star5" name="rate" value="5">
                            <label for="edit-star5">&#9733;</label>
                            <input type="radio" id="edit-star4" name="rate" value="4">
                            <label for="edit-star4">&#9733;</label>
                            <input type="radio" id="edit-star3" name="rate" value="3">
                            <label for="edit-star3">&#9733;</label>
                            <input type="radio" id="edit-star2" name="rate" value="2">
                            <label for="edit-star2">&#9733;</label>
                            <input type="radio" id="edit-star1" name="rate" value="1">
                            <label for="edit-star1">&#9733;</label>
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form_comment.text.label_tag }}
                        {{ form_comment.text }}
                    </div>
                    <button type="submit" class="comment-button save-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" id="cancel-edit-comment-btn" class="comment-button cancel-button">–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </form>
            </div>
        {% else %}
            <p>–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</p>
            <div class="comment-form-container">
                <form method="post" class="comment-form">
                    {% csrf_token %}
                    <div>
                        <p>–û—Ü–µ–Ω–∫–∞:</p>
                        <div class="rating">
                            <input type="radio" id="star5" name="rate" value="5">
                            <label for="star5">&#9733;</label>
                            <input type="radio" id="star4" name="rate" value="4">
                            <label for="star4">&#9733;</label>
                            <input type="radio" id="star3" name="rate" value="3">
                            <label for="star3">&#9733;</label>
                            <input type="radio" id="star2" name="rate" value="2">
                            <label for="star2">&#9733;</label>
                            <input type="radio" id="star1" name="rate" value="1">
                            <label for="star1">&#9733;</label>
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form_comment.text.label_tag }}
                        {{ form_comment.text }}
                    </div>
                    <button type="submit" class="comment-button">–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                </form>
            </div>
        {% endif %}
    {% else %}
    <p class="not-authenticated">–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
    {% endif %}

    <div class="comments-list">
        {% for comment in comments %}
        <div class="comment">
            <p class="comment-author">{{ comment.author.username }}</p>
            <p class="comment-author">–û—Ü–µ–Ω–∫–∞: {{ comment.rate }} / 5</p>
            <p class="comment-text">{{ comment.text }}</p>
            <p class="comment-date">{{ comment.formatted_date }}</p>
        </div>
        {% empty %}
        <p class="no-comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block script %}
{% load static %}
<script src="{% static 'products/js/detail_product.js' %}"></script>
<script>
// –û—Å—Ç–∞–ª—å–Ω–æ–π JavaScript-–∫–æ–¥ (–¥–ª—è –ª–∞–π–∫–æ–≤, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ —Ç.–¥.)
document.getElementById("like-btn").addEventListener("click", function() {
    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "like=1"
    })
    .then(response => response.json())
    .then(data => {
        let btn = document.getElementById("like-btn");
        let text = document.getElementById("like-text");
        let count = document.getElementById("likes-count");

        if (data.liked) {
            text.innerHTML = "üíñ –õ–∞–π–∫–Ω—É—Ç–æ";
        } else {
            text.innerHTML = "ü§ç –õ–∞–π–∫";
        }
        count.innerHTML = data.likes_count;
    });
});
</script>
{% endblock %}